#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="/var/lib/vps-sentry"
LAST_JSON="$STATE_DIR/last.json"
DIFF_JSON="$STATE_DIR/diff.json"
BASELINE_JSON="$STATE_DIR/baseline.json"
FORENSICS_DIR="$STATE_DIR/forensics"
MARKER="$STATE_DIR/last_shipped_ts.txt"

# Prevent overlapping ships (timer + manual runs, or back-to-back systemd starts)
LOCKFILE="$STATE_DIR/ship.lock"
if command -v flock >/dev/null 2>&1; then
  exec 9>"$LOCKFILE"
  if ! flock -n 9; then
    exit 0
  fi
fi

# nothing to ship if last.json doesn't exist
if [[ ! -f "$LAST_JSON" ]]; then
  exit 0
fi

# Read TS / ALERTS / HOST from last.json.
# In v1.0.0, "alerts" is a LIST (confirmed), so count = len(list).
read -r TS ALERTS HOST <<'EOF' < <(
python3 - <<'PY'
import json

p="/var/lib/vps-sentry/last.json"
d=json.load(open(p,"r"))

ts = d.get("ts","") or ""
host = d.get("host","") or ""

a = d.get("alerts", [])
if isinstance(a, list):
    alerts = len(a)
else:
    # fallback if schema changes later
    try:
        alerts = int(a or 0)
    except Exception:
        alerts = 0

print(ts, alerts, host)
PY
)
EOF

# nothing to ship
if [[ "${ALERTS:-0}" -le 0 ]]; then
  exit 0
fi

# if no TS, don't ship (avoid spamming)
if [[ -z "${TS:-}" ]]; then
  exit 0
fi

# Ignore shipping bundles when the ONLY alerts are "Watched files changed"
# AND every changed path is under /var/lib/vps-sentry/test/
set +e
python3 - "$LAST_JSON" <<'PY'
import json, sys

p=sys.argv[1]
d=json.load(open(p,"r"))
alerts=d.get("alerts", [])

# If schema changes, don't suppress.
if not isinstance(alerts, list):
    sys.exit(0)

changed_paths=[]
saw_watched=False

for a in alerts:
    if not isinstance(a, dict):
        continue
    title=(a.get("title") or "").strip()
    detail=(a.get("detail") or "").strip()

    if title.lower() != "watched files changed":
        # Any other alert type => do NOT suppress shipping.
        sys.exit(0)

    saw_watched = True
    # detail typically:
    # "Changed:\n/path1\n/path2"
    for line in detail.splitlines():
        line=line.strip()
        if not line:
            continue
        if line.lower().startswith("changed"):
            continue
        # only keep path-like lines
        if line.startswith("/"):
            changed_paths.append(line)

# Suppress only if we actually saw watched changes, and all are test paths.
if saw_watched and changed_paths and all(p.startswith("/var/lib/vps-sentry/test/") for p in changed_paths):
    sys.exit(10)

sys.exit(0)
PY
rc=$?
set -e
if [[ "$rc" -eq 10 ]]; then
  exit 0
fi
# any other nonzero rc: don't crash the service; just continue shipping logic
# (we'll still dedupe below)

# dedupe: if we already shipped this exact run timestamp, skip
if [[ -f "$MARKER" ]] && [[ "$(cat "$MARKER")" == "$TS" ]]; then
  exit 0
fi

# find discord webhook anywhere inside /etc/vps-sentry.json
WEBHOOK="$(
python3 - <<'PY'
import json

cfg=json.load(open("/etc/vps-sentry.json","r"))

def walk(x):
    if isinstance(x, dict):
        for v in x.values():
            yield from walk(v)
    elif isinstance(x, list):
        for v in x:
            yield from walk(v)
    elif isinstance(x, str):
        yield x

for s in walk(cfg):
    if "discord.com/api/webhooks/" in s or "discordapp.com/api/webhooks/" in s:
        print(s)
        raise SystemExit(0)

raise SystemExit(2)
PY
)" || exit 0

# if webhook empty, nothing we can do
if [[ -z "${WEBHOOK:-}" ]]; then
  exit 0
fi

TMPDIR="$(mktemp -d)"
trap 'rm -rf "$TMPDIR"' EXIT

# Bundle the essentials
cp -f "$LAST_JSON" "$TMPDIR/" || true
cp -f "$BASELINE_JSON" "$TMPDIR/" || true
cp -f "$DIFF_JSON" "$TMPDIR/" 2>/dev/null || true

# include forensics files modified in the last 20 minutes (if any)
if [[ -d "$FORENSICS_DIR" ]]; then
  while IFS= read -r -d '' f; do
    cp -f "$f" "$TMPDIR/" || true
  done < <(find "$FORENSICS_DIR" -maxdepth 1 -type f -mmin -20 -print0 2>/dev/null || true)
fi

SAFE_TS="$(echo "$TS" | tr ': ' '--' | tr -cd '[:alnum:]-._')"
SAFE_HOST="$(echo "${HOST:-host}" | tr -cd '[:alnum:]-._')"
mkdir -p "$STATE_DIR/outbox"
BUNDLE="$STATE_DIR/outbox/ship-${SAFE_HOST:-host}-${SAFE_TS:-now}.tar.gz"

tar -czf "$BUNDLE" -C "$TMPDIR" .

# send to discord (file upload) - best effort
CONTENT="VPS Sentry shipping bundle: host=${HOST:-} ts=${TS} alerts=${ALERTS}"
PAYLOAD="$(python3 - <<PY
import json
print(json.dumps({"content": "${CONTENT}"}))
PY
)"

if curl -fsS -X POST \
  -F "payload_json=$PAYLOAD" \
  -F "file=@${BUNDLE}" \
  "$WEBHOOK" >/dev/null; then
  # only mark shipped if upload succeeded
  echo "$TS" > "$MARKER"
fi

# always delete local bundle to keep disk tiny
rm -f "$BUNDLE" || true

exit 0
