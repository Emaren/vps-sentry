[Service]
# Ensure public dir exists (single source of truth for perms)
ExecStartPost=/bin/sh -lc 'install -d -m 0755 -o root -g root /var/lib/vps-sentry/public'

# Publish canonical/sanitized JSONs (creates: public/status.json + public/last.json + public/diff.json)
ExecStartPost=/usr/local/bin/vps-sentry-publish

# Post-process public/status.json to add unexpected_public_ports_count + filtered list
ExecStartPost=/usr/local/bin/vps-sentry-ports-normalize

# Sanity check (non-fatal)
ExecStartPost=-/usr/local/bin/vps-sentry-app-sanity

# Ship only if alerts > 0 (robust even if .alerts is missing/null)
ExecStartPost=/bin/sh -lc 'jq -e "((.alerts // []) | length) > 0" /var/lib/vps-sentry/last.json >/dev/null 2>&1 && /bin/systemctl start --no-block vps-sentry-ship.service || true'
