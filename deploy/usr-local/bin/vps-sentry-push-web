#!/usr/bin/env bash
set -euo pipefail

# SAFE push-web helper:
# - does NOT embed tokens
# - expects token/url via env or /etc/vps-sentry-push-web.env (0600 root:root)

ENV_FILE="/etc/vps-sentry-push-web.env"
if [[ -f "$ENV_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$ENV_FILE"
fi

URL="${VPS_SENTRY_PUSH_URL:-${1:-}}"
PAYLOAD="${VPS_SENTRY_PUSH_PAYLOAD:-${2:-}}"
TOKEN="${VPS_SENTRY_PUSH_TOKEN:-}"

if [[ -z "${URL:-}" || -z "${PAYLOAD:-}" ]]; then
  cat <<'USAGE' >&2
Usage:
  vps-sentry-push-web <url> <payload.json>

Env (preferred):
  /etc/vps-sentry-push-web.env (0600 root:root):
    VPS_SENTRY_PUSH_URL=...
    VPS_SENTRY_PUSH_TOKEN=...
    VPS_SENTRY_PUSH_PAYLOAD=...

Notes:
- This script intentionally will NOT work without a token in env.
USAGE
  exit 2
fi

if [[ -z "${TOKEN:-}" ]]; then
  echo "FATAL: missing VPS_SENTRY_PUSH_TOKEN (set in /etc/vps-sentry-push-web.env)" >&2
  exit 1
fi

curl -fsS \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  --data-binary @"${PAYLOAD}" \
  "${URL}"
