#!/usr/bin/env bash
set -euo pipefail

STATUS_DEFAULT="/var/lib/vps-sentry/public/status.json"
ENV_FILE="/etc/vps-sentry-push-web.env"

# If there's nothing to send, do nothing (keeps oneshot happy)
STATUS="${VPS_SENTRY_PUSH_PAYLOAD:-$STATUS_DEFAULT}"
if [[ ! -s "$STATUS" ]]; then
  exit 0
fi

# If not configured, do nothing (matches old behavior)
if [[ ! -f "$ENV_FILE" ]]; then
  exit 0
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

# Back-compat + new names:
URL="${VPS_SENTRY_PUSH_URL:-${INGEST_URL:-${1:-}}}"
TOKEN_VAL="${VPS_SENTRY_PUSH_TOKEN:-${TOKEN:-}}"
PAYLOAD="${VPS_SENTRY_PUSH_PAYLOAD:-${2:-$STATUS}}"

# If still not configured, do nothing (keeps service green)
if [[ -z "${URL:-}" || -z "${TOKEN_VAL:-}" ]]; then
  exit 0
fi

curl -fsS \
  -X POST "$URL" \
  -H "Authorization: Bearer ${TOKEN_VAL}" \
  -H "Content-Type: application/json" \
  --data-binary @"$PAYLOAD" \
  >/dev/null